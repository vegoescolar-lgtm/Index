<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SISTEMA VEGO</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #e9ecef; padding: 15px; text-align: center; }
    .container { max-width: 450px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 8px solid #1e88e5; }
    .metodo-card { border: 2px solid #1e88e5; border-radius: 10px; margin-bottom: 15px; padding: 15px; background: #f8fbff; }
    
    /* ESTO ES LO QUE ARREGLA LA MINIATURA */
    #reader { 
      width: 100% !important; 
      min-height: 250px; 
      background: #000; 
      border-radius: 8px; 
      overflow: hidden;
      margin-top: 10px;
      display: block !important; /* Forzamos visibilidad */
    }

    .btn-activar-cam { background: #1e88e5; color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; }
    #status { margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: bold; background: #eee; min-height: 50px; word-break: break-all; }
  </style>
</head>
<body>

<div class="container">
  <h2>SISTEMA VEGO</h2>
  <p>Base de Datos: Tacaton 2.0</p>
  
  <div class="metodo-card">
    <strong>üì∑ C√ÅMARA (QR)</strong>
    <button id="btnCamara" class="btn-activar-cam" onclick="iniciarEscaneo()">‚ñ∂Ô∏è INICIAR ESC√ÅNER</button>
    <div id="reader"></div>
  </div>

  <div class="metodo-card" style="border-color: #2e7d32; background: #f1f8e9;">
    <strong>üîå ESC√ÅNER USB / MANUAL</strong>
    <input type="text" id="txtFisico" style="width:90%; padding:10px; border-radius:5px; border:1px solid #ccc;" placeholder="Escanee o escriba ID..." onkeypress="if(event.key === 'Enter') registrarFisico()">
  </div>

  <div id="status">Esperando lectura...</div>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  // Pega aqu√≠ la URL que termina en /exec de tu Google Apps Script
  const URL_SERVIDOR_VEGO = "https://script.google.com/macros/s/AKfycbxd7H1nCR817Q_2FpasWnNwho5PgHaH07VtB9sXitIdqDdwe99uLpVcnxUYR3QvcB2qkA/exec"; 

  let html5QrCode = null;

  function iniciarEscaneo() {
    const btn = document.getElementById('btnCamara');
    const status = document.getElementById('status');
    
    btn.innerText = "‚åõ Cargando C√°mara...";

    // Configuramos el esc√°ner
    html5QrCode = new Html5Qrcode("reader");
    
   const config = { 
  fps: 25,               // Subimos de 10 a 25 para capturas instant√°neas
  qrbox: { width: 220, height: 220 }, // Caja m√°s peque√±a = enfoque m√°s r√°pido
  aspectRatio: 1.0,
  disableFlip: true      // Ahorra procesamiento al no invertir la imagen
};

html5QrCode.start(
  { facingMode: "environment" }, 
  config,
  (text) => { 
    // Bloqueamos lecturas repetidas por 2 segundos para que no se trabe
    html5QrCode.pause(); 
    enviarDatos(text);
    setTimeout(() => html5QrCode.resume(), 2000); 
  }
);
  }
// --- ESTO SE AGREGA ARRIBA DE TU FUNCI√ìN PARA CAPTURAR EL CORREO ---
let usuarioVego = localStorage.getItem("vego_user");
if (!usuarioVego) {
  usuarioVego = prompt("SISTEMA VEGO: Ingrese su nombre o correo para registrar qui√©n escanea:", "");
  if (usuarioVego) localStorage.setItem("vego_user", usuarioVego);
  else usuarioVego = "Usuario-Externo";
}

// --- ESTO SE AGREGA ARRIBA DE TU FUNCI√ìN PARA CAPTURAR EL CORREO ---
let usuarioVego = localStorage.getItem("vego_user");
if (!usuarioVego) {
  usuarioVego = prompt("SISTEMA VEGO: Ingrese su nombre o correo para registrar qui√©n escanea:", "");
  if (usuarioVego) localStorage.setItem("vego_user", usuarioVego);
  else usuarioVego = "Usuario-Externo";
}

function enviarDatos(codigo) {
  const status = document.getElementById('status');
  let idLimpio = codigo;

  // 1. LIMPIEZA DE ID (Exactamente como la ten√≠as)
  if (codigo.includes("id=")) {
    const urlParams = new URLSearchParams(codigo.split('?')[1]);
    idLimpio = urlParams.get("id");
  }

  status.innerText = "‚åõ Buscando estudiante...";
  status.style.background = "#fff9c4";

  // 2. OPTIMIZACI√ìN DE VELOCIDAD:
  fetch(URL_SERVIDOR_VEGO, {
    method: "POST",
    mode: "cors", 
    keepalive: true, 
    body: JSON.stringify({ 
      id: idLimpio, 
      usuario: usuarioVego // <--- UNICA ADICI√ìN: Enviamos el nombre guardado
    })
  })
  .then(response => response.json()) 
  .then(data => {
    if (data.status === "ok") {
      status.style.background = "#c8e6c9";
      status.innerText = "‚úÖ ESTUDIANTE: " + data.nombre; 
      window.navigator.vibrate(100); 
    } else {
      status.style.background = "#ffcdd2";
      status.innerText = "‚ùå ID NO ENCONTRADO (" + idLimpio + ")";
    }
    
    setTimeout(() => { 
      status.innerText = "Esperando lectura..."; 
      status.style.background = "#eee";
    }, 2000);
  })
  .catch(err => {
    status.innerText = "‚úÖ ID LE√çDO: " + idLimpio; 
  });
}
  function registrarFisico() {
    const input = document.getElementById('txtFisico');
    if(input.value.trim() !== "") {
      enviarDatos(input.value);
      input.value = "";
    }
  }
</script>
</body>
</html>
